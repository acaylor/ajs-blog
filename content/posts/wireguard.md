---
title: Homelab VPN with Wireguard
author: aj
date: 2021-10-19
categories:
  - Homelab
  - Containers
  - Virtual Machines
tags:
  - containers
  - docker
  - wireguard
  - linux
  - virtual machine

---

A [VPN][1] is a way to create a secure tunnel from a remote network onto your own network. When I am not at home I can still trust my DNS requests and access resources from my personal networks. There are different VPN softwares out there and today I will be setting up [WireGuard][2].

![wireguard](/images/wireguard.png)

## Installing and configuring WireGuard with Docker

In order to run the WireGuard server, I will be using a docker container inside of a virtual machine. In order to keep this post concise, please check out [my previous post][3] on docker if you are not familiar with the technology. I also have [a post][4] on setting up virtual machines and [yet another post][5] onsetting up a dedicated system to run virtual machines with proxmox.

#### Requirements

In order to proceed, you must have a suitable Linux System with docker and docker-compose installed. See above for posts that will help you meet these requirements.

The container image that will be used here is created by the [LinuxServer.io][6] team who keep up with regular security updates and publish images that are not affected by the rate limits of the public Docker Hub.

### Wireguard template

In order to preserve the configuration of the WireGuard server that is running in a docker container, we can user a `docker-compose` template. Save the following as a `docker-compose.yml` file in a location that you will remember and that is not readable by any user.

```yaml
---
version: "2.1"
services:
  wireguard:
    image: ghcr.io/linuxserver/wireguard
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - SERVERURL=wireguard.example.com #set this to your public hostname or IP
      - SERVERPORT=51820 #optional for running on a different port
      - PEERS=1 #optional for increasing # of allowed connected clients
      - PEERDNS=auto #optional "auto" will use Host's DNS
      - INTERNAL_SUBNET=10.13.13.0 #optional change wireguard client subnet
      - ALLOWEDIPS=0.0.0.0/0 #optional only allow certain client IPs to connect
    volumes:
      - /path/to/appdata/config:/config
      - /lib/modules:/lib/modules
    ports:
      - 51820:51820/udp
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    restart: unless-stopped
```

Once this template has been saved, the WireGuard server can be started with the following command:

```bash
docker-compose up -d
```

### Upgrading to new versions

Run these commands in the directory with the `docker-compose.yml` template:

```bash
docker-compose pull
docker-compose up -d
```

### Port forwarding

Now in order to connect to your WireGuard server from the internet, you must open the associated port in your firewall and if on a consumer ISP, the best bet is to [port forward][7] the WireGuard port to your Internet gateway or router provided by your ISP.

In the example above, the server was configured to use port **51820/udp**

## Configuring a WireGuard client

Now that the WireGuard server is running, note the IP address and/or DNS hostname of the system. Wait a few minutes for the container to intialize and then run the following command to output the container logs:

```bash
docker-compose logs wireguard
```

Within this output should be a QR code. We can use this to configure a client to connect to the server.

### Connect iOS client

To connect an iOS client, download the official client [from the Apple App store][8]. Once the application is downloaded, press the + in the upper right to add a new server. In the following menu, select "Create from QR code". If you lost the QR code, enter the following command in the container shell:

```bash
qrencode -t ansiutf8 < tunnel.conf
```

Line up your camera with the output of the docker-compose logs to scan the QR code generated by the wireguard container. Once the code has scanned, you can choose a name for the VPN connection. Now you should be able to toggle on and off the connection through the WireGuard app.

![wireguard_ios](/images/wireguard_ios.png)

 [1]: https://en.wikipedia.org/wiki/Virtual_private_network
 [2]: https://www.wireguard.com/
 [3]: /posts/containers/
 [4]: /posts/getting-started-with-virtual-machines/
 [5]: /posts/proxmox-installation/
 [6]: https://linuxserver.io
 [7]: https://portforward.com/
 [8]: https://apps.apple.com/us/app/wireguard/id1441195209